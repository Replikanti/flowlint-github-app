name: AI Release Gate
on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
  workflow_dispatch:

jobs:
  filter-and-merge:
    # Run only on release-please branches
    if: startsWith(github.ref_name, 'release-please--') || startsWith(github.head_ref, 'release-please--')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      
      - name: Get PR Details
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Determine branch name
          BRANCH=${{ github.head_ref || github.ref_name }}
          # Remove 'refs/heads/' prefix if present
          BRANCH=${BRANCH#refs/heads/}
          
          echo "Checking PR for branch: $BRANCH"
          
          PR_DATA=$(gh pr list --head "$BRANCH" --state open --json number,body --limit 1)
          NUMBER=$(echo "$PR_DATA" | jq '.[0].number')
          
          if [ "$NUMBER" == "null" ] || [ -z "$NUMBER" ]; then
            echo "No open PR found for branch $BRANCH"
            exit 1
          fi
          
          BODY=$(echo "$PR_DATA" | jq -r '.[0].body')
          
          echo "number=$NUMBER" >> $GITHUB_OUTPUT
          
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "body<<$EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT

      - name: Setup Node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install openai tsx

      - name: Run AI Filter
        id: ai
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PR_BODY: ${{ steps.pr.outputs.body }}
        run: |
          OUTPUT=$(npx tsx scripts/ai-release-filter.ts)
          echo "RAW OUTPUT LENGTH: ${#OUTPUT}"
          
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "result<<$EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT

      - name: Process Result
        env:
          GH_TOKEN: ${{ secrets.AUTO_APPROVE_PAT }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          RESULT: ${{ steps.ai.outputs.result }}
        run: |
          if [[ "$RESULT" == *"NO_RELEASE"* ]]; then
            echo "No business value detected. Closing PR #$PR_NUMBER."
            gh pr close $PR_NUMBER --comment "AI Release Gate: No significant business value detected. Closing."
          else
            echo "Business value detected. Merging PR #$PR_NUMBER."
            gh pr edit $PR_NUMBER --body "$RESULT"
            gh pr review $PR_NUMBER --approve
            gh pr merge $PR_NUMBER --auto --merge
          fi