version: '3.9'

networks:
  flowlint_net:
    driver: bridge

volumes:
  flowlint_redis_data:
  flowlint_prometheus_data:
  flowlint_grafana_data:
  flowlint_tempo_data:

services:
  redis:
    image: redis:8.4@sha256:3906b477e4b60250660573105110c28bfce93b01243eab37610a484daebceb04
    container_name: flowlint-redis
    restart: unless-stopped
    command: ["redis-server", "--save", "60", "1000", "--appendonly", "yes"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 1s
      timeout: 3s
      retries: 5
    volumes:
      - flowlint_redis_data:/data
    networks:
      - flowlint_net

  tempo-init:
    image: alpine:latest@sha256:865b95f46d98cf867a156fe4a135ad3fe50d2056aa3f25ed31662dff6da4eb62
    user: root
    command: sh -c "mkdir -p /var/lib/tempo/wal /var/lib/tempo/blocks && chown -R 10001:10001 /var/lib/tempo && chmod -R 755 /var/lib/tempo"
    volumes:
      - flowlint_tempo_data:/var/lib/tempo
    networks:
      - flowlint_net

  tempo:
    image: ghcr.io/replikanti/flowlint-tempo:latest@sha256:a8482d0e918ef78002b862af40953be1789581d6726d8d549328066d9f8b289d
    container_name: flowlint-tempo
    pull_policy: always
    command:
      - "-config.file=/etc/tempo.yaml"
      - "-target=all"
    volumes:
      - ./tempo/tempo.yaml:/etc/tempo.yaml:ro
      - flowlint_tempo_data:/var/lib/tempo
    ports:
      - '127.0.0.1:3200:3200'
      - '127.0.0.1:4318:4318'
      - '127.0.0.1:4317:4317'
    networks:
      - flowlint_net
    restart: unless-stopped
    depends_on:
      tempo-init:
        condition: service_completed_successfully

  api:
    image: ghcr.io/replikanti/flowlint-backend:latest@sha256:41c4b44412943ca788c5c2257c2c99300ae699a9e3a01360e1b42c7f11523d7c
    container_name: flowlint-api
    pull_policy: always
    command: node dist/apps/api/src/server.js
    env_file:
      - ../.env
    environment:
      NODE_ENV: production
      PORT: 8080
      REDIS_URL: redis://flowlint-redis:6379
      TRUST_PROXY: '1'
      OTEL_SERVICE_NAME: flowlint-api
      OTEL_EXPORTER: otlp-http
      OTEL_EXPORTER_OTLP_ENDPOINT: http://flowlint-tempo:4318/v1/traces
      OTEL_TRACES_SAMPLER: parentbased_traceidratio
      OTEL_TRACES_SAMPLER_ARG: '0.1'
    networks:
      - flowlint_net
    ports:
      - '127.0.0.1:18080:8080'
    depends_on:
      redis:
        condition: service_healthy
      tempo:
        condition: service_started
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8080/healthz', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      start_period: 40s
      retries: 3

  worker:
    image: ghcr.io/replikanti/flowlint-backend:latest@sha256:41c4b44412943ca788c5c2257c2c99300ae699a9e3a01360e1b42c7f11523d7c
    container_name: flowlint-worker
    pull_policy: always
    command: node dist/apps/worker/src/worker.js
    env_file:
      - ../.env
    environment:
      NODE_ENV: production
      REDIS_URL: redis://flowlint-redis:6379
      OTEL_SERVICE_NAME: flowlint-worker
      OTEL_EXPORTER: otlp-http
      OTEL_EXPORTER_OTLP_ENDPOINT: http://flowlint-tempo:4318/v1/traces
      OTEL_TRACES_SAMPLER: parentbased_traceidratio
      OTEL_TRACES_SAMPLER_ARG: '0.1'
    networks:
      - flowlint_net
    restart: unless-stopped
    stop_grace_period: 60s
    depends_on:
      redis:
        condition: service_healthy
      tempo:
        condition: service_started
    healthcheck:
      disable: true

  prometheus:
    image: ghcr.io/replikanti/flowlint-prometheus:latest@sha256:c5642aa696c699289d91e9f303e0139853a4e7293b39dda96c7f3d9e9b68831f
    container_name: flowlint-prometheus
    pull_policy: always
    restart: unless-stopped
    volumes:
      - flowlint_prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    networks:
      - flowlint_net
    ports:
      - '127.0.0.1:9090:9090'
    depends_on:
      - api
      - tempo

  grafana:
    image: ghcr.io/replikanti/flowlint-grafana:latest@sha256:9bda45b2082fa9afc0beee99c6f962cb36aa2d8c8238d03b3ef471e31c490d2c
    container_name: flowlint-grafana
    pull_policy: always
    restart: unless-stopped
    volumes:
      - flowlint_grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:3000
      - GF_ANALYTICS_REPORTING_ENABLED=false
      - GF_ANALYTICS_CHECK_FOR_UPDATES=false
      - GF_FEATURE_TOGGLES_ENABLE=traceqlEditor
    networks:
      - flowlint_net
    ports:
      - '127.0.0.1:3000:3000'
    depends_on:
      - prometheus
      - tempo
